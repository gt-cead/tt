rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}")) %>%
separate(class,
into = paste("Nivel",
1:max(str_count(.$class, "\\.")),
sep = "_"),
sep = "\\.")
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
qde_niveis = str_count(.$class, "\\.")) %>%
separate(class,
into = paste("Nivel",
1:max(),
sep = "_"),
sep = "\\.",
remove = FALSE)
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}")) %>%
separate(class,
into = paste("Nivel",
1:max(str_count(.$class, "\\.")),
sep = "_"),
sep = "\\.",
remove = FALSE)
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
qde_niveis = str_count("\\.")) %>%
separate(class,
into = paste("Nivel",
1:max(.$qde_niveis),
sep = "_"),
sep = "\\.",
remove = FALSE)
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
qde_niveis = str_count(class, "\\.")) %>%
separate(class,
into = paste("Nivel",
1:max(.$qde_niveis),
sep = "_"),
sep = "\\.",
remove = FALSE)
str_sub("IV.", Inf, Inf)
str_sub("IV.", Inf)
str_sub("IV.", -1, -1)
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
qde_niveis = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1)) %>%
separate(class,
into = paste("Nivel",
1:max(.$qde_niveis),
sep = "_"),
sep = "\\.",
remove = FALSE)
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1),
ult_nivel = ifelse(nivel == 1,
"Agregadora",
ifelse(str_detect(class,
paste0(class,".")),
"Agregadora",
"Ultimo_nivel")
)
) %>%
separate(class,
into = paste("Nivel",
1:max(.$nivel),
sep = "_"),
sep = "\\.",
remove = FALSE)
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1),
ult_nivel = ifelse(nivel == 1,
"Agregadora",
ifelse(str_detect(.$class,
paste0(class,".")),
"Agregadora",
"Ultimo_nivel")
)
) %>%
separate(class,
into = paste("Nivel",
1:max(.$nivel),
sep = "_"),
sep = "\\.",
remove = FALSE)
str_detect(tabela_desp2$class, ".")
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1),
ult_nivel = ifelse(nivel == 1,
"Agregadora",
if_else(str_detect(.$class,
paste0(class,".")),
"Agregadora",
"Ultimo_nivel")
)
) %>%
separate(class,
into = paste("Nivel",
1:max(.$nivel),
sep = "_"),
sep = "\\.",
remove = FALSE)
a <- tabela_desp2$class
b <- paste0(a, ".")
b
c <- data.frame(a, b)
c %>% mutate(z = str_detect(a, b))
c %>% mutate_all(.funs = ~as.character(.))
c<-c %>% mutate_all(.funs = ~as.character(.))
c %>% mutate(z = str_detect(a, b))
c %>% mutate(z = str_detect(a, c$b))
c %>% mutate(z = str_detect(c$a, b))
A <- a
c %>% mutate(z = str_detect(A, b))
str_detect(A, "IV.3.21."))
str_detect(A, "IV.3.21.")
str_count(A, "IV.3.21.")
sum(str_count(A, "IV.3.21."))
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1),
conta = sum(str_count(.$class, class)))
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1),
conta = sum(str_count(class, class)))
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1),
conta = sum(str_count(.$class, class)))
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1)
) %>%
separate(class,
into = paste("Nivel",
1:max(.$nivel),
sep = "_"),
sep = "\\.",
remove = FALSE) %>%
rowwise() %>%
mutate(contagem = sum(str_count(.$class, paste0(class,"."))))
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
#arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1)
) %>%
separate(class,
into = paste("Nivel",
1:max(.$nivel),
sep = "_"),
sep = "\\.",
remove = FALSE) %>%
rowwise() %>%
mutate(contagem = sum(str_count(.$class, paste0(class,"."))))
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
#arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1)
) %>%
separate(class,
into = paste("Nivel",
1:max(.$nivel),
sep = "_"),
sep = "\\.",
remove = FALSE) %>%
rowwise() %>%
mutate(contagem = sum(str_count(.$class, paste0(class,"\\."))))
tabela_desp2 <- tabela_desp %>%
rename(rotulos = 1) %>%
filter(str_sub(rotulos,1,2) == "IV") %>%
mutate_at(-1, .funs = ~as.numeric(.)) %>%
mutate(total = rowSums(.[-1])) %>%
select(rotulos, total) %>%
#arrange(desc(total)) %>%
filter(!is.na(total)) %>%
mutate(class = str_extract(tabela_desp2$rotulos, "IV[\\.\\d]{1,}"),
nivel = ifelse(str_sub(class, -1, -1) == ".",
1,
str_count(class, "\\.") + 1)
) %>%
separate(class,
into = paste("Nivel",
1:max(.$nivel),
sep = "_"),
sep = "\\.",
remove = FALSE) %>%
rowwise() %>%
mutate(ultimo_nivel = ifelse(str_sub(class, -1, -1) == ".",
"Agregadora",
ifelse(sum(str_count(.$class,
paste0(class,"\\."))) > 0,
"Agregadora",
"Ult_nivel")))
ggplot(tabela_desp2 %>% filter(ultimo_nivel == "Ult_nivel"), aes(y = total, x = reorder(rotulos, total))) +
geom_col() +
coord_flip()
plot1 <- ggplot(tabela_desp2 %>% filter(ultimo_nivel == "Ult_nivel"), aes(y = total, x = reorder(rotulos, total))) +
geom_col() +
coord_flip()
plot1 + theme_light()
dados_desp_RGPS <- read.csv2("../base-siafi-tt/dados/base_Siafi_exRGPS.csv")
dados_desp_nRGPS <- read.csv2("../base-siafi-tt/dados/base_Siafi_exRGPS.csv")
dados_desp_nRGPS$RGPS <- FALSE
dados_desp_RGPS$RGPS  <- TRUE
dados_desp <- rbind(dados_desp_nRGPS, dados_desp_RGPS)
dados_desp_RGPS <- read.csv2("../base-siafi-tt/dados/base_Siafi_soRGPS.csv")
dados_desp_RGPS$RGPS  <- TRUE
dados_desp_nRGPS$RGPS <- FALSE
dados_desp <- rbind(dados_desp_nRGPS, dados_desp_RGPS)
dados_desp_nRGPS <- NULL
dados_desp_RGPS <- NULL
colnames(dados_desp)
# arrumando um pouco
colnames(dados_desp) <- c("Esfera_cod",
"Esfera_nome",
"Funcao_cod",
"Funcao_nome",
"Subfuncao_cod",
"Subfuncao_nome",
"Programa_cod",
"Programa_nome",
"Acao_cod",
"Acao_nome",
"GND_cod",
"GND_nome",
"Modalidade_cod",
"Modalidade_nome",
"Elemento_cod",
"Elemento_nome",
"Fonte_id",
"Fonte_cod",
"Fonte_nome",
"ResultadoPrim_cod",
"ResultadoPrim_nome",
"ExcecaoProgFin_cod",
"Ano",
"Mes",
"Periodo",
"ItemInfo_id",
"ItemInfo_nome",
"ItemInfo_cod",
"SaldoAnterior",
"SaldoAtual",
"DespesaRGPS")
head(dados_desp)
dados_desp %>% tail()
# arrumando um pouco
colnames(dados_desp) <- c("Esfera_cod",
"Esfera_nome",
"Funcao_cod",
"Funcao_nome",
"Subfuncao_cod",
"Subfuncao_nome",
"Programa_cod",
"Programa_nome",
"Acao_cod",
"Acao_nome",
"GND_cod",
"GND_nome",
"Modalidade_id",
"Modalidade_cod",
"Modalidade_nome",
"Elemento_cod",
"Elemento_nome",
"Fonte_id",
"Fonte_cod",
"Fonte_nome",
"ResultadoPrim_cod",
"ResultadoPrim_nome",
"ExcecaoProgFin_cod",
"Ano",
"Mes",
"Periodo",
"ItemInfo_id",
"ItemInfo_nome",
"ItemInfo_cod",
"SaldoAnterior",
"SaldoAtual",
"DespesaRGPS")
dados_desp %>% tail()
# arrumando um pouco
colnames(dados_desp) <- c("Esfera_cod",
"Esfera_nome",
"Funcao_cod",
"Funcao_nome",
"Subfuncao_cod",
"Subfuncao_nome",
"Programa_cod",
"Programa_nome",
"Acao_cod",
"Acao_nome",
"GND_cod",
"GND_nome",
"Modalidade_id",
"Modalidade_cod",
"Modalidade_nome",
"Elemento_id",
"Elemento_cod",
"Elemento_nome",
"Fonte_id",
"Fonte_cod",
"Fonte_nome",
"ResultadoPrim_cod",
"ResultadoPrim_nome",
"ExcecaoProgFin_cod",
"Ano",
"Mes",
"Periodo",
"ItemInfo_id",
"ItemInfo_nome",
"ItemInfo_cod",
"SaldoAnterior",
"SaldoAtual",
"DespesaRGPS")
dados_desp %>% tail()
dim(dados_desp)
glimpse(dados_desp)
dados <- dados_desp %>%
filter(!(Mes_num %in% c(13, 14))) %>%
mutate(Periodo = as.Date(paste0(Ano, "-",
str_pad(Mes_num, width = 2, pad = "0"), "-",
"01")),
SaldoAnterior = as.numeric(as.character(SaldoAnterior)),
SaldoAtual = as.numeric(as.character(SaldoAtual)),
Valor = round(SaldoAtual - SaldoAnterior, 2)) %>%
filter(!(Funcao_cod %in% c("-7","-9")) &
!(GND_cod %in% c("-7","-9")) &
!(Modalidade_cod %in% c("-7","-9"))) %>%
select(-SaldoAtual, -SaldoAnterior, vars(ends_with("_id")))
dados <- dados_desp %>%
filter(!(Mes_num %in% c(13, 14))) %>%
mutate(Periodo = as.Date(paste0(Ano, "-",
str_pad(Mes, width = 2, pad = "0"), "-",
"01")),
SaldoAnterior = as.numeric(as.character(SaldoAnterior)),
SaldoAtual = as.numeric(as.character(SaldoAtual)),
Valor = round(SaldoAtual - SaldoAnterior, 2)) %>%
filter(!(Funcao_cod %in% c("-7","-9")) &
!(GND_cod %in% c("-7","-9")) &
!(Modalidade_cod %in% c("-7","-9"))) %>%
select(-SaldoAtual, -SaldoAnterior, vars(ends_with("_id")))
dados <- dados_desp %>%
filter(!(Mes %in% c(13, 14))) %>%
mutate(Periodo = as.Date(paste0(Ano, "-",
str_pad(Mes, width = 2, pad = "0"), "-",
"01")),
SaldoAnterior = as.numeric(as.character(SaldoAnterior)),
SaldoAtual = as.numeric(as.character(SaldoAtual)),
Valor = round(SaldoAtual - SaldoAnterior, 2)) %>%
filter(!(Funcao_cod %in% c("-7","-9")) &
!(GND_cod %in% c("-7","-9")) &
!(Modalidade_cod %in% c("-7","-9"))) %>%
select(-SaldoAtual, -SaldoAnterior, -vars(ends_with("_id")))
dados <- dados_desp %>%
filter(!(Mes %in% c(13, 14))) %>%
mutate(Periodo = as.Date(paste0(Ano, "-",
str_pad(Mes, width = 2, pad = "0"), "-",
"01")),
SaldoAnterior = as.numeric(as.character(SaldoAnterior)),
SaldoAtual = as.numeric(as.character(SaldoAtual)),
Valor = round(SaldoAtual - SaldoAnterior, 2)) %>%
filter(!(Funcao_cod %in% c("-7","-9")) &
!(GND_cod %in% c("-7","-9")) &
!(Modalidade_cod %in% c("-7","-9"))) %>%
select(-SaldoAtual, -SaldoAnterior, -ends_with("_id"))
glimpse(dados)
dados_desp$SaldoAnterior[5000:5010,]
dados_desp$SaldoAnterior[5000:5010]
dados <- dados_desp %>%
filter(!(Mes %in% c(13, 14))) %>%
mutate(Periodo = as.Date(paste0(Ano, "-",
str_pad(Mes, width = 2, pad = "0"), "-",
"01")),
SaldoAnterior = as.numeric(as.character(SaldoAnterior)),
SaldoAtual = as.numeric(as.character(SaldoAtual))) %>%
replace_na(list(SaldoAnterior = 0, SaldoAtual = 0)) %>%
mutate(Valor = round(SaldoAtual - SaldoAnterior, 2)) %>%
filter(!(Funcao_cod %in% c("-7","-9")) &
!(GND_cod %in% c("-7","-9")) &
!(Modalidade_cod %in% c("-7","-9"))) %>%
select(-SaldoAtual, -SaldoAnterior, -ends_with("_id"))
glimpse(dados)
dados %>% group_by(Ano) %>% summarise(Total_ano = sum(Valor))
dados_desp$Ano
unique(dados_desp$Ano)
