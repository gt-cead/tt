---
output: 
   html_document:
     code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{css, echo=FALSE}
* {
  font-family: "Open Sans";
}

h1, h2, h3, h4 {
  color: #1E4C7A;
}

.destaque {
  margin: 10px 30px;
  font-size: 12px;
  color: "white";
  background-color: #e59405;
  padding: 5px 10px;
  border: 2px solid #BA3917;
}

.center {
  margin: auto;
}
```

![](home_TT_rtn.gif)

O gráfico acima demonstra a evolução do "Resultado Primário do Governo Central", uma das principais informações fiscais apuradas e divulgada pelo Teosuro Nacional. 
Os valores representam, para cada mês, a soma dos resultados mensais, atualizados por um índice de inflação, o IPCA, dos últimos 12 meses. Os resultados positivos são indicados pela cor **<span style="color: #1E4C7A">azul</span>**; os negativos, pela cor **<span style="color: #E41A1C">vermelha</span>**. 

Aqui tentaremos demonstrar de forma rápida como o gráfico foi construído e indicar onde é possível obter informações adicionais.

```{r libraries}
library(tidyverse)
library(readxl)
library(scales)
library(ggrepel)
#library(ipeaData)
library(extrafont)
library(gganimate)
library(RColorBrewer)
library(ckanr)
library(zoo)

tema <- function(){
    theme_minimal() +
    theme(
      text = element_text(family = "Open Sans", colour = "grey20"),
      title = element_text(face = "bold", size = 14, color = "#1E4C7A"), 
      plot.subtitle = element_text(family = "Open Sans Condensed", color = "grey20", face = "plain", size = 12),
      axis.text = element_text(family = "Open Sans", colour = "grey20", size = 10),
      plot.caption = element_text(face = "italic"),
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      legend.text = element_text(size = 14),
      legend.title = element_text(size = 14),
      axis.ticks = element_line(size = 0.5),
      axis.ticks.length = unit(.25, "cm"),
      axis.title = element_text(size = 8, colour = "grey20"),
      legend.position = 'none')
}

tema_gif <- function() {
  theme(legend.position = 'none',
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.background = element_rect(color = "#f0f5f7", linetype = "solid", size = 2))
}

vermelho <- brewer.pal(3, name = "Set1")[1]
azul <- "#1f476a" 

vermelho_claro <- "#ee7576"
azul_claro     <- "#2c90bf" # "#87b1d4"

```

## Os dados

Os dados utilizados estão disponíveis [aqui mesmo no Tesouro Transparente](http://www.tesourotransparente.gov.br/ckan/dataset/resultado-do-tesouro-nacional), na forma de [Dados Abertos](http://www.tesourotransparente.gov.br/sobre/dados-abertos). 

Mensalmente o Tesouro Nacional faz a divulgação do [Resultado do Tesouro Nacional (RTN)](http://www.tesouro.gov.br/web/stn/resultado-do-tesouro-nacional) e atualiza as planilhas disponíveis no link acima. A série completa apresenta dados desde janeiro de 1997.

```{r importa, echo=FALSE}
# recurso_TT <- resource_show(id="527ccdb1-3059-42f3-bf23-b5e3ab4c6dc6",
#                             url="https://apickan.tesouro.gov.br/ckan")
# download.file(recurso_TT$url, destfile = "./rtn.xlsx", mode = 'wb' )
tabela <- read_excel("rtn.xlsx", sheet = "1.1-A", skip = 4)
```

Vamos utilizar a planilha "1.1-A - Resultado Primário do Governo Central - Mensal - Valores reais (IPCA)", que já apresenta os valores históricos atualizados pelos índices de inflação do IPCA.

```{r, processamento-dos-dados}

# criando a função geral de processamento para tratar a tabela original e gerar os sub-datasets já num formato tidy

pipe_da_tabela <- function(dados) {
  dados %>% 
  rename(rotulos = 1) %>%
  gather(-1, key = "Periodo", value = "Valores") %>%
  spread(key = rotulos, value = Valores) %>%
  mutate_at(-1, funs(zoo::rollapply(as.numeric(.), width = 12, FUN = sum, fill = NA, align = 'right'))) %>%
  mutate(Periodo = as.Date(as.numeric(Periodo), origin = "1899-12-30")) %>%
  gather(-1, key = "rubrica", value = "Valor_12m") %>%
  filter(!is.na(Valor_12m))
}

# linhas de interesse para cada sub-dataset

linha_RecTotal <- which(tabela$`Discriminação` == "I. RECEITA TOTAL")
linha_Transf <- which(tabela$`Discriminação` == "II. TRANSF. POR REPARTIÇÃO DE RECEITA")
linha_DespTotal <- which(tabela$`Discriminação` == "IV. DESPESA TOTAL")
linha_FSB <- which(tabela$`Discriminação` == "V. FUNDO SOBERANO DO BRASIL")

# gerando os sub-datasets para cada gráfico

rec_desp <- pipe_da_tabela(tabela %>% rename(rotulos = 1) %>%
                             filter(str_detect(rotulos, "RECEITA LÍQUIDA") | 
                                    str_detect(rotulos, "DESPESA TOTAL")) %>%
                             mutate(rotulos = c("Receita", "Despesa")))

rec <- pipe_da_tabela(tabela %>% 
                        filter(row_number() >= linha_RecTotal & row_number() <= linha_Transf - 1))

desp <- pipe_da_tabela(tabela %>% 
                        filter(row_number() >= linha_DespTotal & row_number() <= linha_FSB - 1))

rtn <- pipe_da_tabela(tabela %>% rename(rotulos = 1) %>%
                        filter(str_detect(rotulos, "VI. PRIMÁRIO GOVERNO"))) %>%
  mutate(Resultado = ifelse(Valor_12m > 0, "Positivo", "Negativo"))

```

No gráfico apresentado na página inicial do Tesouro Transparente, apresentamos o Resultado Primário a partir de 2006, para que o período coincidisse com o período do gráfico da Dívida Pública Federal. Aqui, no entanto, vamos visualizar as séries inteiras. 

Para chegar ao gráfico do resultado, vamos inicialmente observar o comportamento de seus componentes: as receitas e despesas primárias.

## As receitas e as despesas primárias

Neste documento, mostraremos apenas um panorama geral da composição e do comportamento das receitas e despesas primárias.

As tabelas do RTN demonstram a composição das receitas e despesas primárias nas suas diversas rubricas. Mensalmente, na divulgação do RTN, o Tesouro publica o Relatório e a Apresentação do RTN. Esses documentos buscam evidenciar e analisar as principais alterações nos componentes das Receitas e Despesas primárias ocorridas no mês de referência.

Aqui no Tesouro Transparente, a história ["Ressignificando o Resultado do Tesouro Nacional"](http://www3.tesourotransparente.gov.br/historias/ressignificando-o-resultado-do-tesouro-nacional) permite explorar de forma visual e interativa toda a série histórica e todas as rubricas que compõem o RTN, além de contextualizar os dados apresentados por meio da exibição dos próprios relatórios mensais de todo o período (desde 1997!) a partir de um simples clique.

### As receitas

Se visualizarmos as receitas totais acumuladas nos últimos 12 meses para cada mês de referência, a partir dos dados disponíveis na planilha, obteremos o seguinte gráfico.

```{r, fig.width=9}
rec_desp_plot <- rec_desp %>%
  spread(rubrica, Valor_12m) %>%
  mutate(resultado = Receita > Despesa,
         y_min = ifelse(resultado, Receita, Despesa),
         y_max = ifelse(!resultado, Receita, Despesa))

ggplot(rec_desp_plot, aes(x = Periodo)) +
  geom_line(aes(y = Receita), color = azul, size = 1.5) + 
  geom_hline(yintercept = 0, color = '#f0f5f7', size = 1) +
  scale_x_date(date_breaks = "2 years", 
               date_labels = "%Y") +
  scale_y_continuous(labels = function(x) {format(x/1000, big.mark = ".", decimal.mark = ",")}) +
  coord_cartesian(clip = 'on') + 
  labs(x = NULL, y = "R$ bilhões",
       title = "Receitas Primárias Líquidas do Governo Central",
       subtitle = "Soma dos últimos 12 meses, atualizados pelo IPCA") +
  tema() + theme(axis.title.y = element_text(hjust = 1))

```

Como dito, as tabelas do RTN evidenciam a composição dessas receitas. Esses componentes possuem muitas vezes uma estrutura hierárquica, agrupando rubricas mais detalhadas em classificadores mais concisos. Observando a estrutura da tabela 1.1-A, percebe-se que as receitas se desdobram, num primeiro nível, nas seguintes rubricas:

* Receita Administrada pela RFB (composta principalmente por impostos e contribuições, exceto as contribuições previdenciárias);
* Incentivos Fiscais;
* Arrecadação Líquida para o RGPS (composta principalmente pelas contribuições previdenciárias destinadas ao Regime Geral de Previdência Social); e
* Receitas Não Administradas pela RFB (composta por diversas receitas, tais como concessões e permissões, dividendos, contribuições previdenciárias do servidores federais, Compensações financeiras etc.).

Apenas para dar uma idéia da composição do gráfico anterior, a figura seguinte mostra o desdobramento das receitas primárias nessas rubricas. Há uma nuance, no entanto: o gráfico anterior mostra as receitas primárias **líquidas**, ou seja, descontadas das transferências a Estados, Municípios e Distrito Federal por repartição de receita. Já o gráfico abaixo mostra as receitas totais, antes da distribuição das receitas aos demais entes federados.

```{r, fig.width=9}
receitas <- c("I.1 -  Receita Administrada pela RFB", "I.2 -  Incentivos Fiscais", 
"I.3 -  Arrecadação Líquida para o RGPS", "I.4 -  Receitas Não Administradas pela RFB"
)

receitas_simplificada <- data.frame("rubrica" = receitas, "rubrica_simples" = c("Receitas administradas pela RFB", "Incentivos Fiscais", "Arrecadação líquida RGPS", "Receitas não administradas pela RFB"))

rec_plot <- rec%>%filter(str_detect(rubrica, "-")) %>%
  left_join(receitas_simplificada)

paleta_receitas <- rev(brewer.pal(9, "Blues")[c(3,5,6,8)])
paleta_texto_rec <- c("white", rep("#1f476a", 3))

ggplot(data = rec_plot, aes(x = Periodo, y = Valor_12m, fill = rubrica)) +
  geom_area(color = NA) + 
  geom_text(aes(color = rubrica, label = ifelse(Periodo == max(Periodo), as.character(rubrica_simples), NA)), size = 3.5, position = position_stack(vjust = 0.5), hjust = "right", family = "Open Sans") +
  scale_fill_manual(values = paleta_receitas) + 
  scale_color_manual(values = paleta_texto_rec) +
  scale_x_date(date_breaks = "2 years", 
               date_labels = "%Y") +
  scale_y_continuous(labels = function(x) {format(x/1000, big.mark = ".", decimal.mark = ",")}) +
  coord_cartesian(clip = 'on') + 
  labs(x = NULL, y = "R$ bilhões", title = "Composição básica da Receita Primária Total", subtitle = "Soma dos últimos 12 meses, atualizados pelo IPCA") +
  tema() + theme(axis.title.y = element_text(hjust = 1))
```

<div class = "destaque">
Mais uma vez, recomendamos acessar o ["Ressignificando o Resultado do Tesouro Nacional"](http://www3.tesourotransparente.gov.br/historias/ressignificando-o-resultado-do-tesouro-nacional) para uma exploração interativa e completa de todas as rubricas do RTN!
</div>

### Despesas

Se adotarmos o mesmo procedimento para as despesas, obteremos inicialmente o gráfico abaixo.

```{r}
ggplot(rec_desp_plot, aes(x = Periodo)) +
  geom_line(aes(y = Despesa), color = vermelho, size = 1.5) + 
  geom_hline(yintercept = 0, color = '#f0f5f7', size = 1) +
  scale_x_date(date_breaks = "2 years", 
               date_labels = "%Y") +
  scale_y_continuous(labels = function(x) {format(x/1000, big.mark = ".", decimal.mark = ",")}) +
  coord_cartesian(clip = 'on') + 
  labs(x = NULL, y = "R$ bilhões",
       title = "Despesas Primárias do Governo Central",
       subtitle = "Soma dos últimos 12 meses, atualizados pelo IPCA") +
  tema() + theme(axis.title.y = element_text(hjust = 1))
```


```{r, fig.width=9}
primeiro_mes_negativo <- subset(rtn, rtn$Resultado == "Negativo")$Periodo[1]

ggplot(rtn, aes(x = Periodo, y = Valor_12m, color = Resultado, fill = Resultado, group = 1)) +
  annotate("rect", xmin = primeiro_mes_negativo, xmax = max(rtn$Periodo) + 100, 
           ymin = -Inf, ymax = Inf, fill = "#F0F5F7") +
  annotate("text", x = primeiro_mes_negativo, y = -Inf, label = "11/2014", hjust = "center", 
           vjust = "bottom", size = 2.5, fontface = 'plain', family = "Open Sans", color = "grey10") +
  geom_area(aes(group = Resultado)) +
  geom_line(size = 1) + 
  geom_hline(yintercept = 0, color = '#f0f5f7', size = 1) +
  geom_point(aes(y = ifelse(Periodo == primeiro_mes_negativo, Valor_12m, NA)),
             size = 3, shape = 21) +
  scale_color_manual(values = c("Negativo" = vermelho, "Positivo" = azul)) +
  scale_fill_manual(values = c("Negativo" = vermelho_claro, "Positivo" = azul_claro)) +  
  scale_x_date(date_breaks = "2 years", 
               date_labels = "%Y") +
  scale_y_continuous(labels = function(x) {format(x/1000, big.mark = ".", decimal.mark = ",")}) +
  coord_cartesian(clip = 'on') + 
  labs(x = NULL, y = "R$ bilhões",
       title = "Resultado Primário do Governo Central",
       subtitle = "Soma dos últimos 12 meses, atualizados pelo IPCA") +
  tema() + theme(axis.title.y = element_text(hjust = 1))


```

O resultado primário corresponde à diferença entre Receitas e Despesas. Quando as receitas superam as despesas, temos um _superávit primário_. Era o que ocorria até novembro de 2014, como a figura indica. A partir desse mês, o Governo Central passou a incorrer em _déficit primário_ no acumulado em 12 meses. 

Para deixar essa relação mais clara, vamos visualizar o comportamento das receitas e das despesas.


```{r, fig.width=9}
plot_rec_desp <- ggplot(rec_desp_plot, aes(x = Periodo)) +
  annotate("rect", xmin = primeiro_mes_negativo, xmax = max(rtn$Periodo) + 100, 
           ymin = 0, ymax = Inf, fill = "#F0F5F7") +
  geom_line(aes(y = Receita), color = azul, size = 1.5) + 
  geom_line(aes(y = Despesa), color = vermelho, size = 1.5) + 
  geom_hline(yintercept = 0, color = '#f0f5f7', size = 1) +
  scale_fill_manual(values = c("FALSE" = vermelho_claro, "TRUE" = azul_claro)) +  
  scale_x_date(date_breaks = "2 years", 
               date_labels = "%Y") +
  scale_y_continuous(labels = function(x) {format(x/1000, big.mark = ".", decimal.mark = ",")}) +
  coord_cartesian(clip = 'on') + 
  labs(x = NULL, y = "R$ bilhões") +
  tema() + theme(axis.title.y = element_text(hjust = 1))

plot_rec_desp
plot_rec_desp + geom_ribbon(aes(ymin = y_min, ymax = y_max, fill = resultado),
                            alpha = 0.5, color = NA)

```


## Receitas



##despesas

```{r}
despesas <- c("IV. DESPESA TOTAL", "IV.1  Benefícios Previdenciários", "IV.2  Pessoal e Encargos Sociais", "IV.3  Outras Despesas Obrigatórias", "IV.4  Despesas Discricionárias - Todos os Poderes")

despesas_simplificada <- data.frame("rubrica" = despesas, "rubrica_simples" = c("Total", "Benefícios RGPS", "Pessoal", "Outras obrigatórias", "Discricionárias"))

desp_plot <- desp %>%
  filter(rubrica %in% despesas) %>%
  left_join(despesas_simplificada) %>%
  filter(rubrica_simples != "Total")
```

```{r, fig.width = 9}
ggplot(desp_plot, aes(x = Periodo, y = Valor_12m, fill = rubrica_simples)) +
  geom_area(color = "white", size = 1) + 
  geom_text(aes(label = ifelse(Periodo == max(Periodo), as.character(rubrica_simples), NA)), size = 3, position = position_stack(vjust = 0.5), hjust = "right", family = "Open Sans") +
  scale_fill_brewer(palette = "Reds", direction = -1) +
  scale_x_date(date_breaks = "2 years", 
               date_labels = "%Y") +
  scale_y_continuous(labels = function(x) {format(x/1000, big.mark = ".", decimal.mark = ",")}) +
  coord_cartesian(clip = 'on') + 
  labs(x = NULL, y = "R$ bilhões") +
  tema() + theme(axis.title.y = element_text(hjust = 1))
```

Vamos marcar o primeiro valor negativo


diminuir width!

```{r eval=FALSE, cache=TRUE, include=FALSE}
gif_linhas <- grafico_linha +
  transition_reveal(1, Periodo) 
#  labs(subtitle = "{frame_along}") 

animate(gif_linhas, nframes = round(nrow(rtn)/1.5, 0), height = 480, width = 800)


#anim_save("historia_graf_rtn.gif", animation = last_animation())

```

```{r eval=FALSE, fig.width=9, include=FALSE}
# código não usado

library(streamgraph)

# rec_plot %>% streamgraph(rubrica, Valor_12m, Periodo) %>%
#   sg_axis_x(2, "year", "%Y") %>%
#   sg_fill_manual(brewer.pal(8, "Blues")[5:8])
# #  sg_fill_brewer("Blues")
# 
# 
# desp_plot %>% streamgraph(rubrica, Valor_12m, Periodo) %>%
#   sg_axis_x(2, "year", "%Y") %>%
#   sg_fill_brewer("Reds")

```